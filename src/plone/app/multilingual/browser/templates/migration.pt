<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"
      xmlns:tal="http://xml.zope.org/namespaces/tal"
      xmlns:metal="http://xml.zope.org/namespaces/metal"
      xmlns:i18n="http://xml.zope.org/namespaces/i18n"
    lang="en"
    metal:use-macro="context/prefs_main_template/macros/master"
    i18n:domain="plone.app.multilingual">

<body>

<div metal:fill-slot="prefs_configlet_content">

<script type="text/javascript">
(function($) {

    $().ready(function() {
        $('.formControls input[name="form.button.relocate-content"]').click(function (event) {
          event.preventDefault();
          $('.results').html('<img src="spinner.gif">');
          var blacklist = $('textarea#blacklist')[0].value;
          var url = "@@relocate-content?blacklist:list=" + blacklist.split('\n').join('&blacklist:list=');
          $.get(url, function(data) {
            $('.results').html(data)
          });
        });

        $('.formControls input[name="form.button.transfer-lp-catalog"]').click(function (event) {
          event.preventDefault();
          $('.results').html('<img src="spinner.gif">');
          $.get('@@transfer-lp-catalog', function(data) {
            $('.results').html(data)
          });
        });

        $('.formControls input[name="form.button.after-migration-cleanup"]').click(function (event) {
          event.preventDefault();
          $('.results').html('<img src="spinner.gif">');
          $.get('@@after-migration-cleanup', function(data) {
            $('.results').html(data)
          });
        });

       $('.formControls input[name="form.button.reindex-language-index"]').click(function (event) {
          event.preventDefault();
          $('.results').html('<img src="spinner.gif">');
          $.get('@@reindex-language-index', function(data) {
            $('.results').html(data)
          });
        });
    });

})(jQuery);
</script>

  <div id="region-content" class="documentEditable">

    <div id="edit-bar" i18n:domain="plone.app.multilingual">
        <ul class="contentViews" id="content-views">
          <li>
            <a href=""
               tal:attributes="href string:${portal_url}/@@language-controlpanel"
               i18n:translate="label_general">General</a>
          </li>
          <li>
            <a href=""
               tal:attributes="href string:${portal_url}/@@multilingual-map"
               i18n:translate="label_translation_map">Translation Map</a>
          </li>
          <li class="selected">
            <a href=""
               tal:attributes="href string:${portal_url}/@@lp-migration"
               i18n:translate="label_migration">Migration</a>
          </li>
        </ul>
        <div class="contentActions">&nbsp;</div>
    </div>

    <div class="documentContent" id="content">
      <a name="documentContent"></a>

        <div metal:use-macro="context/global_statusmessage/macros/portal_message">
        Portal status message
        </div>

        <div class="configlet">

            <h1 class="documentFirstHeading"
                i18n:translate="heading_migration">Products.LinguaPlone Migration</h1>

            <a href=""
                class="link-parent"
                tal:attributes="href string:${portal_url}/plone_control_panel"
                i18n:translate="label_up_to_plone_setup">
                    Up to Site Setup
            </a>

            <p i18n:translate="description_migrate">

                The migration process is divided into four steps, listed
                below. Each one of the steps has a well defined purpose
                explained. Some of them are destructive, so please read each
                one of it and do not try to run it on production servers
                without testing it previously.

            </p>

            <form name="reindex"
                  tal:attributes="action string:${portal_url}/reindex-language-index"
                  method="post">
              <fieldset>
                <legend i18n:translate="legend_reindex_language_index">
                  Optional step - Reindex the Language index
                </legend>

                <p i18n:translate="help_reindex_language_index">

                 The migration of LinguaPlone content depends on an up-to-date Language
                 index. Use this step to refresh this index.
                 Warning: Depending on the number of items in your site, this can take
                 a considerable amount of time.

                </p>

                <div class="formControls">
                    <input
                        type="submit"
                        name="form.button.reindex-language-index"
                        class="destructive"
                        value="Reindex"
                        i18n:attributes="value" />
                </div>

                <input tal:replace="structure context/@@authenticator/authenticator" />

              </fieldset>
            </form>

            <form name="relocate"
                  tal:attributes="action string:${portal_url}/relocate-content"
                  method="post">
              <fieldset>
                <legend i18n:translate="legend_relocate_content">
                  Step 1 - Relocate content to the proper root language folder
                </legend>

                <p i18n:translate="description_relocate_content">
                  This step will move the site's content to its corresponding
                  root language folder and previously will make a search for
                  misplaced content through the site's content tree and will
                  move them to its nearest translated parent. This step is
                  destructive as it will alter your content tree structure.
                  Make sure you have previously configured your site's
                  languages properly in the 'Site Languages' tab of the
                  'Languages' control panel.
                </p>

                <div>
                    <p i18n:translate="description_relocate_blacklist">
                        Use this field to define portal types that will not be traversed for finding content to move.
                        All content of those types will be moved with all contained sub-items. This is useful
                        for content types that are themselves translatable, but contain sub-content that is not
                        translatable or does not have a language set.<br />
                        This list is pre-filled with some portal types, but you can add additional ones if needed,
                        one per line.
                    </p>
                    <textarea name="blacklist" id="blacklist" rows="5" tal:content="python: '\n'.join(view.portal_types_blacklist)">
                    </textarea>
                </div>

                <div class="formControls">
                    <input
                        type="submit"
                        name="form.button.relocate-content"
                        class="destructive"
                        value="Relocate"
                        i18n:attributes="value" />
                </div>

                <input tal:replace="structure context/@@authenticator/authenticator" />

              </fieldset>
            </form>

            <form name="transfer"
                  tal:attributes="action string:${portal_url}/transfer-lp-catalog"
                  method="post">
              <fieldset>
                <legend i18n:translate="legend_transfer_multilingual_catalog_info">
                  Step 2 - Transfer multilingual catalog information
                </legend>

                <p i18n:translate="description_transfer_multilingual_catalog_info">

                  This step will transfer the relations between translations
                  stored by LinguaPlone to the PAM catalog. This step is not
                  destructive and can be executed as many times as needed.

                </p>

                <div class="formControls">
                    <input
                        type="submit"
                        name="form.button.transfer-lp-catalog"
                        class="destructive"
                        value="Transfer"
                        i18n:attributes="value" />
                </div>

                <input tal:replace="structure context/@@authenticator/authenticator" />

              </fieldset>
            </form>

            <form name="aftermigration"
                  tal:condition="view/hasRelationCatalog"
                  tal:attributes="action string:${portal_url}/after-migration-cleanup"
                  method="post">
              <fieldset>
                <legend i18n:translate="legend_after_migration_cleanup">
                  Step 3 - Cleanup after migration
                </legend>

                <p i18n:translate="description_after_migration_cleanup">

                  This step will fix some lost dependencies to the
                  ITranslatable interface hidden in the relation catalog and
                  it gets rid of them. It must be run only when LinguaPlone is
                  already uninstalled.

                </p>

                <div class="formControls">
                    <input
                        type="submit"
                        name="form.button.after-migration-cleanup"
                        class="destructive"
                        value="Cleanup"
                        i18n:attributes="value" />
                </div>

                <input tal:replace="structure context/@@authenticator/authenticator" />

              </fieldset>
            </form>

            <div class="results">
              <h3>Migration results</h3>
            </div>
        </div>
      </div>
    </div>
</div>

</body>
</html>
